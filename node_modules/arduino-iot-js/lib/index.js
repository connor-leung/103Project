"use strict";function n(n){return n&&"object"==typeof n&&"default"in n?n.default:n}Object.defineProperty(exports,"__esModule",{value:!0});var t=n(require("@arduino/cbor-js")),e=n(require("node-fetch")),r=n(require("mqtt")),o=require("rxjs/operators"),i=require("rxjs"),c=n(require("jws")),u=function(n,t){return(u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var e in t)t.hasOwnProperty(e)&&(n[e]=t[e])})(n,t)};var s=function(){return(s=Object.assign||function(n){for(var t,e=1,r=arguments.length;e<r;e++)for(var o in t=arguments[e])Object.prototype.hasOwnProperty.call(t,o)&&(n[o]=t[o]);return n}).apply(this,arguments)};function a(n,t,e,r){return new(e||(e=Promise))((function(o,i){function c(n){try{s(r.next(n))}catch(n){i(n)}}function u(n){try{s(r.throw(n))}catch(n){i(n)}}function s(n){var t;n.done?o(n.value):(t=n.value,t instanceof e?t:new e((function(n){n(t)}))).then(c,u)}s((r=r.apply(n,t||[])).next())}))}function f(n,t){var e,r,o,i,c={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(e)throw new TypeError("Generator is already executing.");for(;c;)try{if(e=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return c.label++,{value:i[1],done:!1};case 5:c.label++,r=i[1],i=[0];continue;case 7:i=c.ops.pop(),c.trys.pop();continue;default:if(!(o=c.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){c=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){c.label=i[1];break}if(6===i[0]&&c.label<o[1]){c.label=o[1],o=i;break}if(o&&c.label<o[2]){c.label=o[2],c.ops.push(i);break}o[2]&&c.ops.pop(),c.trys.pop();continue}i=t.call(n,c)}catch(n){i=[6,n],r=0}finally{e=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}}function p(){for(var n=0,t=0,e=arguments.length;t<e;t++)n+=arguments[t].length;var r=Array(n),o=0;for(t=0;t<e;t++)for(var i=arguments[t],c=0,u=i.length;c<u;c++,o++)r[o]=i[c];return r}var l={ArduinoCloudError:function(n){function t(t,e){var r=n.call(this,e)||this;r.code=t,r.name=r.constructor.name;try{Error.captureStackTrace(r,r.constructor)}catch(n){}return r}return function(n,t){function e(){this.constructor=n}u(n,t),n.prototype=null===t?Object.create(t):(e.prototype=t.prototype,new e)}(t,n),t}(Error),isObject:function(n){return"object"==typeof n},isNumber:function(n){return"number"==typeof n},isString:function(n){return"string"==typeof n},isBoolean:function(n){return"boolean"==typeof n},isArray:function(n){return Array.isArray(n)},toArrayBuffer:function(n){for(var t=new ArrayBuffer(n.length),e=new Uint8Array(t),r=0;r<n.length;++r)e[r]=n[r];return t},toBuffer:function(n){for(var t=new Buffer(n.byteLength),e=new Uint8Array(n),r=0;r<t.length;++r)t[r]=e[r];return t},arrayBufferToBase64:function(n){for(var t="",e=new Uint8Array(n),r=e.byteLength,o=0;o<r;o+=1)t+=String.fromCharCode(e[o]);return window.btoa(t)},isNotAnEmptyObject:function(n){return!("object"==typeof n&&0==Object.keys(n).length)}};function h(n){return!!n.n}function b(n){return null==n}function d(){for(var n=[],t=0;t<arguments.length;t++)n[t]=arguments[t];return n.find((function(n){return!b(n)}))}function v(n){var t={},e=null;return Object.keys(n).forEach((function(r){switch(r){case"bn":e=-2;break;case"bt":e=-3;break;case"bu":e=-4;break;case"bv":e=-5;break;case"bs":e=-6;break;case"bver":e=-1;break;case"n":e=0;break;case"u":e=1;break;case"v":e=2;break;case"vs":e=3;break;case"vb":e=4;break;case"vd":e=8;break;case"s":e=5;break;case"t":e=6;break;case"ut":e=7;break;default:e=r}t[e]=n[r]})),t}function y(n,t,e,r){var o={};return-1!==e&&(o.bt=e||(new Date).getTime()),o.n=t,r&&(o.bn="urn:uuid:"+r),l.isNumber(n)&&(o.v=n),l.isString(n)&&(o.vs=n),l.isBoolean(n)&&(o.vb=n),o}var m={CBOR:t,parse:function(n,t,e,r,o){if(e&&!Number.isInteger(e))throw new Error("Timestamp must be Integer");if(void 0===n||"string"!=typeof n)throw new Error("Name must be a valid string");if(l.isObject(t))return Object.keys(t).map((function(r,i){return y(t[r],n+":"+r,0===i?e:-1,0===i?o:void 0)})).map((function(n){return r?v(n):n}));var i=y(t,n,e,o);return r&&(i=v(i)),i},toString:function(n,e){var r=t.encode(n,e);return l.arrayBufferToBase64(r)},valueFrom:function(n){return h(n)?d(n.v,n.vs,n.vb):d(n[2],n[3],n[4])},nameFrom:function(n){return h(n)?n.n:n[0]},isPropertyValue:h,toCloudProtocolV2:v},w=function(){function n(){}return n.Create=function(n){return new(function(){function t(){}return t.prototype.post=function(n,t,e){return this.execute(n,"post",t,e)},t.prototype.execute=function(t,e,r,o){return a(this,void 0,void 0,(function(){var i,c,u,s,a;return f(this,(function(f){switch(f.label){case 0:return[4,n(t,{method:e,body:r,headers:o})];case 1:return i=f.sent(),c=this.mapFrom(i.headers),[4,i.text()];case 2:if(u=f.sent(),s=c["content-type"]||"",a=s.match("json")&&u?JSON.parse(u):u,i.status>=400)throw new Error(JSON.stringify({payload:a,status:i.status}));return[2,a]}}))}))},t.prototype.mapFrom=function(n){var t={};return n.forEach((function(n,e){return t[e]=n})),t},t}())},n}(),g=function(){return null},k=function(){function n(n){void 0===n&&(n=[]),this.builders=n,this.subscriptions={},this.callbacks={},this.propertiesCbs={},this.options={ssl:!1,host:"wss.iot.arduino.cc",port:8443,token:void 0,useCloudProtocolV2:!0,onOffline:g,onConnected:g,onDisconnect:g}}return n.From=function(t){var e=new n;return e.init(t),e},n.prototype.connect=function(n){return a(this,void 0,void 0,(function(){var t,e,r=this;return f(this,(function(o){switch(o.label){case 0:if(this.options=s(s({},this.options),n),!(t=this.builders.find((function(n){return n.canBuild(r.options)}))))throw new Error("connection failed: options not valid");return[4,t.build(this.options)];case 1:return e=o.sent(),[2,this.init(e)]}}))}))},n.prototype.init=function(n){return a(this,void 0,void 0,(function(){var t=this;return f(this,(function(e){if(this.connection)throw new Error("connection failed: connection already open");return this.connection=n,[2,new Promise((function(n,e){return a(t,void 0,void 0,(function(){var t=this;return f(this,(function(r){return this.connection.on("offline",(function(){return t.options.onOffline()})),this.connection.on("disconnect",(function(){return t.options.onDisconnect()})),this.connection.on("error",(function(n){return e(new l.ArduinoCloudError(5,n.toString()))})),this.connection.on("connect",(function(){return t.options.onConnected(),n(t.connection)})),[2]}))}))}))]}))}))},n.prototype.disconnect=function(){var n=this;return new Promise((function(t,e){if(!n.connection)return e(new Error("disconnection failed: connection closed"));try{n.connection.end(!0)}catch(n){return e(n)}return n.connection=null,Object.values(n.subscriptions).forEach((function(t,e){t.forEach((function(n){return n.unsubscribe()})),delete n.callbacks[e],delete n.propertiesCbs[e],delete n.subscriptions[e]})),t()}))},n.prototype.reconnect=function(){return a(this,void 0,void 0,(function(){return f(this,(function(n){return this.connection.reconnect(),[2]}))}))},n.prototype.updateToken=function(n){return a(this,void 0,void 0,(function(){var t,e,r=this;return f(this,(function(o){switch(o.label){case 0:o.label=1;case 1:return o.trys.push([1,3,,5]),this.connection&&(this.connection.end(),this.connection=null),[4,this.connect(s(s({},this.options),{token:n}))];case 2:return o.sent(),Object.keys(this.subscriptions).forEach((function(n){r.subscriptions[n].forEach((function(n){return n.unsubscribe()})),delete r.subscriptions[n];var t=r.callbacks[n]?p(r.callbacks[n]):[],e=r.propertiesCbs[n]?p(r.propertiesCbs[n]):[];delete r.callbacks[n],delete r.propertiesCbs[n],t.forEach((function(t){return r.subscribe(n,t)})),e.forEach((function(n){var t=n.thingId,e=n.name,o=n.cb;return r.onPropertyValue(t,e,o)}))})),t=this.options.onConnected,(void 0===t?g:t)(),[2];case 3:return e=o.sent(),console.error(e),[4,new Promise((function(n){return setTimeout(n,5e3)}))];case 4:return o.sent(),[3,5];case 5:return[3,0];case 6:return[2]}}))}))},n.prototype.getToken=function(){if(!this.connection)throw new Error("send message failed: no connection found");return this.connection.token},n.prototype.sendMessage=function(n,t){var e=this;return new Promise((function(r,o){if(!e.connection)return o(new Error("send message failed: no connection found"));var i=l.isString(t)?Buffer.from(t,"utf8"):t;return e.connection.publish(n,l.toBuffer(i),{qos:1,retain:!1}),r()}))},n.prototype.sendProperty=function(n,t,e,r){return void 0===r&&(r=(new Date).getTime()),a(this,void 0,void 0,(function(){var o,i;return f(this,(function(c){return o="/a/t/"+n+"/e/i",i=m.parse(t,e,r,this.options.useCloudProtocolV2,null),[2,this.sendMessage(o,m.CBOR.encode(l.isArray(i)?i:[i],this.options.useCloudProtocolV2))]}))}))},n.prototype.onPropertyValue=function(n,t,e){return a(this,void 0,void 0,(function(){var r;return f(this,(function(i){if(!t)throw new Error("Invalid property name");if("function"!=typeof e)throw new Error("Invalid callback");return r="/a/t/"+n+"/e/o",this.propertiesCbs[r]=this.propertiesCbs[r]||[],this.subscriptions[r]=this.subscriptions[r]||[],this.propertiesCbs[r].push({thingId:n,name:t,cb:e}),this.subscriptions[r].push(this.messagesFrom(r).pipe(o.filter((function(n){return n.propertyName===t}))).subscribe((function(n){return e(n.value)}))),[2]}))}))},n.prototype.subscribe=function(n,t){var e=this;return new Promise((function(r,o){try{return e.callbacks[n]=e.callbacks[n]||[],e.callbacks[n].push(t),e.subscriptions[n]=e.subscriptions[n]||[],e.subscriptions[n].push(e.messagesFrom(n).subscribe((function(n){return t(n.value)}))),r()}catch(n){o(n)}}))},n.prototype.unsubscribe=function(n){var t=this;return new Promise((function(e,r){return t.connection?t.connection.unsubscribe(n,null,(function(n){return n?r():e()})):r(new Error("unsubscribe failed: no connection found"))}))},n.prototype.messagesFrom=function(n){var t,e=this;if(!this.connection)throw new Error("subscription failed: no connection found");var r=new i.Subject;this.connection.subscribe(n,(function(i){if(i)throw new Error("subscription failed: "+i.toString());t=e.connection.messages.pipe(o.filter((function(t){return t.topic===n}))).subscribe((function(n){return r.next(n)}))}));var c=r.unsubscribe;return r.unsubscribe=function(){t.unsubscribe(),c()},r},n}(),E={clean:!0,keepalive:30,properties:{},protocolVersion:4,connectTimeout:3e4},C=function(){function n(){}return Object.defineProperty(n.prototype,"client",{get:function(){return this._client},set:function(n){var t=this;this._client=n;var e=this.messages=new i.Subject;this._client.on("message",(function(n,r){n.indexOf("/s/o")>-1?e.next({topic:n,value:r.toString()}):t.messagesFrom(n,r).forEach((function(n){return e.next(n)}))}))},enumerable:!1,configurable:!0}),n.From=function(t,e,r,o){return a(this,void 0,void 0,(function(){var i,u,a;return f(this,(function(f){if(!r)throw new Error("connection failed: you need to provide a valid token");if(!t)throw new Error("connection failed: you need to provide a valid host (broker)");return i=c.decode(r).payload["http://arduino.cc/id"],u={clientId:i+":"+(new Date).getTime(),username:i,password:r},(a=new n).client=o("wss://"+t+":"+e+"/mqtt",s(s({},E),u)),a.token=r,[2,a]}))}))},n.prototype.on=function(n,t){return this.client.on(n,t),this},n.prototype.end=function(n,t,e){return this.client.end(n,t,e),this},n.prototype.reconnect=function(n){return this.client.reconnect(n),this},n.prototype.unsubscribe=function(n,t,e){return this.client.subscribe(n,t,e),this},n.prototype.publish=function(n,t,e,r){return this.client.publish(n,t,e,r),this},n.prototype.subscribe=function(n,t){return this.client.subscribe(n,t),this},n.prototype.messagesFrom=function(n,t){var e="",r="",o="",i={},c=[];return m.CBOR.decode(l.toArrayBuffer(t)).forEach((function(t){var u,s=m.valueFrom(t);u=m.nameFrom(t).split(":"),e=u[0],r=u[1],""===o&&(o=e),o!==e&&(c.push({topic:n,propertyName:o,value:i}),o=e,i={}),r?i[r]=s:i=s})),l.isNotAnEmptyObject(i)&&c.push({topic:n,propertyName:e,value:i}),c},n}();var O=function(){function n(n,t){this.client=n,this.mqttConnect=t}return n.prototype.canBuild=function(n){return function(n){return!!n.clientId}(n)},n.prototype.build=function(n){return a(this,void 0,void 0,(function(){var t,e,r,o,i;return f(this,(function(c){switch(c.label){case 0:return t=n.apiUrl,e=void 0===t?"https://api2.arduino.cc/iot/v1/clients/token":t,r={"content-type":"application/x-www-form-urlencoded"},(o=new URLSearchParams).append("grant_type","client_credentials"),o.append("client_id",n.clientId),o.append("client_secret",n.clientSecret),o.append("audience",n.audience||"https://api2.arduino.cc/iot"),[4,this.client.post(e,o,r)];case 1:return i=c.sent().access_token,[2,C.From(n.host,n.port,i,this.mqttConnect)]}}))}))},n}(),j=new k([new(function(){function n(n){this.mqttConnect=n}return n.prototype.canBuild=function(n){return!!n.token},n.prototype.build=function(n){var t=n.host,e=n.port,r=n.token;return C.From(t,e,r,this.mqttConnect)},n}())(r.connect),new O(w.Create(e),r.connect)]);exports.ArduinoIoTCloud=j,exports.SenML=m;
//# sourceMappingURL=index.js.map
